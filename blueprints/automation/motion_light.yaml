blueprint:
  name: ðŸ’¡Ð¡Ð²ÐµÑ‚ Ð¿Ð¾ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸ÑŽ
  domain: automation
  input:
    in_motion:
      name: Ð”Ð°Ñ‚Ñ‡Ð¸Ðº Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ
      description: Ð”Ð°Ñ‚Ñ‡Ð¸Ðº Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ
      selector:
        entity:
          device_class: motion
    in_light:
      name: Ð›Ð°Ð¼Ð¿Ð°
      description: Ð›Ð°Ð¼Ð¿Ð°
      selector:
        entity:
          domain: light
    in_time_min:
      name: Ð’Ñ€ÐµÐ¼Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
      description: Ð’Ñ€ÐµÐ¼Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
      default: 00:01:00
      selector:
        time:
    in_time_max:
      name: Ð’Ñ€ÐµÐ¼Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
      description: Ð’Ñ€ÐµÐ¼Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
      default: 00:05:00
      selector:
        time:
    in_time_ojd:
      name: Ð’Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð°
      description: Ð’Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð° Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð½Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð¸ ÐµÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°
      default: 00:10:00
      selector:
        time:
    in_night:
      name: ÐŸÑ€Ð¸Ð·Ð½Ð°Ðº Ð´Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð½Ð¾Ñ‡Ð½Ñ‹Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð¼
      description: ÐŸÑ€Ð¸Ð·Ð½Ð°Ðº Ð´Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð½Ð¾Ñ‡Ð½Ñ‹Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð¼
      selector:
        entity:
    in_night_brightness:
      name: Ð¯Ñ€ÐºÐ¾ÑÑ‚ÑŒ Ð´Ð»Ñ Ð½Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
      description: Ð¯Ñ€ÐºÐ¾ÑÑ‚ÑŒ Ð´Ð»Ñ Ð½Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
      default: 40
      selector:
        number:
          min: 0
          max: 100
    in_action_in:
      name: Ð”ÐµÐ¹ÑÐ²Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼
      description: Ð”ÐµÐ¹ÑÐ²Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼
      default: []
      selector:
        action:
    in_action_out:
      name: Ð”ÐµÐ¹ÑÐ²Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
      description: Ð”ÐµÐ¹ÑÐ²Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
      default: []
      selector:
        action:
    in_condition:
      name: Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      description: Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      default: []
      selector:
        action:


trigger:
  - platform: state
    id: trig_on
    entity_id:
      - !input in_motion
    to: 'on'


  - platform: homeassistant
    event: start
  # - platform: state
  #   id: trig_on
  #   entity_id:
  #     - !input in_motion
  #   to: 'on'
  #   for:
  #     hours: 0
  #     minutes: 1
  #     seconds: 0
  - platform: state
    id: motion_time_off
    entity_id:
      - !input in_motion
    to: 'off'
    for: !input in_time_ojd



  - platform: state
    id: trig_on
    entity_id:
      - !input in_light
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
condition: 


  - condition: and
    conditions:
      !input in_condition

  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: motion_time_off
          - condition: state
            entity_id: !input in_light
            state: "off"
      - condition: not
        conditions:
          - condition: trigger
            id: motion_time_off



action:
  - variables:
      light_id: !input in_light
  - if:
      - or:
          - condition: state
            entity_id: !input in_motion
            state: 'on'
          - condition: trigger
            id: trig_on
    then:
      - variables:
          max: >-
            {%-if as_timestamp(now()) - as_timestamp(states[light_id].last_changed)|float<120 and states(light_id)=='off'-%}
            1
            {%-else-%}
            0
            {%-endif-%}
      - choose:
          - conditions: []
            sequence: !input in_action_in
      - if:
          - condition: state
            entity_id: !input in_night
            state: 'on'
        then:
          - service: light.turn_on
            data:
              brightness_pct: !input in_night_brightness
            target:
              entity_id: !input in_light
        else:
          - service: light.turn_on
            data:
              brightness_pct: 100
            target:
              entity_id: !input in_light
      - if:
          - condition: template
            value_template: '{{max==0}}'
        then:
          - wait_for_trigger:
              - platform: state
                entity_id:
                  - !input in_motion
                to: 'off'
                for: !input in_time_min
              - platform: state
                entity_id:
                  - !input in_light
                to: 'off'
            timeout: !input in_time_ojd
          - if:
              - condition: state
                entity_id: !input in_light
                state: 'off'
            then:
              - stop: Ð»Ð°Ð¼Ð¿Ð° Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°
      - if:
          - condition: state
            entity_id: !input in_motion
            state: 'on'
        then:
          - wait_for_trigger:
              - platform: state
                entity_id:
                  - !input in_motion
                to: 'off'
                for: !input in_time_max
            continue_on_timeout: false
      - choose:
          - conditions: []
            sequence: !input in_action_out
  - service: light.turn_off
    data: {}
    target:
      entity_id: !input in_light
mode: single
trace:
  stored_traces: 30
max_exceeded: silent