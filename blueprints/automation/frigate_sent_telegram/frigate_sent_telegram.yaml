blueprint:
  name: üì∏–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º —Å–∫—Ä–∏–Ω–æ–≤ —Å–æ–±—ã—Ç–∏–π Frigate –∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  domain: automation
  description: |
    #### –í —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–Ω–æ–ø–∫–∏:
    - üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä–∏–º –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    - ‚ùå –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ Frigate –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ telegram.
    - üìº –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –Ω–∞ –≤–∏–¥–µ–æ.
    - üîö –ó–∞–º–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ –Ω–∞ —Ñ–æ—Ç–æ.
    - üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç.
  input:
    in_camera:
      name: –ö–∞–º–µ—Ä–∞
      description: –ö–∞–º–µ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∏–º—è –∫–æ—Ç–æ—Ä–æ–π –±–µ—Ä–µ—Ç—Å—è –¥–ª—è —Å–≤–µ—Ä–∫–∏ —Å –∏–º–µ–Ω–µ–º –∫–∞–º–µ—Ä—ã –≤ —Å–æ–±—ã—Ç–∏–∏ mqtt.
      selector:
        entity:
          domain: camera
          integration: frigate
    in_notify:
      name: –°–ª—É–∂–±–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      description: –°–ª—É–∂–±–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è **telegram** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
      default: telegram_send
      selector:
        template:
    in_notify_mobile:
      name: –°–ª—É–∂–±–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      description: –°–ª—É–∂–±–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è **–º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**, –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç—Ä–∏–º–∞ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–æ –∫–Ω–æ–ø–∫–µ üì≤.
      default: notify
      selector:
        template:
    in_text_message:
      name: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      description: –î–æ—Å—Ç—É–ø–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ camera, camera_friendly_name, start_time, end_time, offset_zones, object, url_thumb –∏ —à–∞–±–ª–æ–Ω—ã.
      default: "üì∏*–î–≤–∏–∂–µ–Ω–∏–µ* {{camera_friendly_name}}{{'\n'-}}‚è±{{start_time}} –ø–æ {{end_time}}{{'\n'-}}üéØ{{offset_zones}}"
      selector:
        template:
    in_type_photo:
      name: –¢–∏–ø –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      description: –î–æ—Å—Ç—É–ø–Ω—ã thumbnail - –º–∏–Ω–∏–∞—Ç—é—Ä–∞ –æ–±—ä–µ–∫—Ç–∞, snapshot - –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–∞–¥—Ä–∞.
      default: thumbnail
      selector:
        select:
          options:
            - thumbnail
            - snapshot
    in_url_frigate:
      name: –ê–¥—Ä–µ—Å Frigate
      description: –ê–¥—Ä–µ—Å Frigate, –Ω–∞—á–∏–Ω–∞—è —Å **http://...**
      default: http://ccab4aaf-frigate:5000
      selector:
        text:
    in_time_wait:
      name: (–î–æ–ø) –í—Ä–µ–º—è –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤–∏–¥–µ–æ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ
      description: –í—Ä–µ–º—è –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤–∏–¥–µ–æ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ.
      default: 00:01:00
      selector:
        time:
    in_zones:
      name: (–î–æ–ø) –ó–æ–Ω—ã
      description: –°–ø–∏—Å–æ–∫ –∑–æ–Ω —á–µ—Ä–µ–∑ "-" —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. 
      default: []
      selector:
        object:
    in_object_event:
      name: (–î–æ–ø) –û–±—ä–µ–∫—Ç—ã —Å–æ–±—ã—Ç–∏–π
      description: –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ "-" —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. 
      default: []
      selector:
        object:
    in_condition:
      name: (–î–æ–ø) –£—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      description: –¢–∏–ø –¥–µ–π—Ç—Å–≤–∏—è –≤—ã–±—Ä–∞—Ç—å —É—Å–ª–æ–≤–∏–µ. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ —Å mqtt frigate.
      default: []
      selector:
        action:
    in_action:
      name: (–î–æ–ø) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      description: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –¥–æ—Å—Ç—É–ø–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ camera, camera_friendly_name, start_time, end_time, offset_zones, object, url_thumb, mes_caption
      default: []
      selector:
        action:

trace:
  stored_traces: 7

mode: parallel

max: 1000

variables:
  in_url_frigate: !input in_url_frigate
  in_notify: !input in_notify
  in_type_photo: !input in_type_photo
  event_notify: "{{in_notify.replace('notify.', '')}}"
  in_notify_mobile: !input in_notify_mobile
  notify_mobile: "{{in_notify_mobile.replace('notify.', '')}}"
  in_camera: !input in_camera
  camera_friendly_name: "{{state_attr(in_camera, 'friendly_name').replace('-', ' ')}}"
  in_zones: !input in_zones
  in_object_event: !input in_object_event
  frigate_api: "{{in_url_frigate}}/api/events"

trigger_variables:
  in_camera: !input in_camera
  camera: "{{in_camera|replace('camera.', '')}}"

trigger:
  - platform: mqtt
    topic: frigate/events
    payload: "{{camera}}/new"
    value_template: "{{ value_json['after']['camera'] | lower | replace('-','_') }}/{{ value_json['type']}}"
    id: frigate-event
  - platform: event
    event_type: telegram_callback
    event_data:
      command: "/frigate_{{camera}}"
    id: telegram-command

condition: []

action:
  - choose:
      - alias: "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏–∑ frigate"
        conditions:
          - condition: trigger
            id: frigate-event
        sequence:
          - condition: !input in_condition
          - variables:
              video_id: "{{trigger.payload_json['after']['id']}}"
              camera: "{{trigger.payload_json['after']['camera']}}"
              label: "{{trigger.payload_json['after']['label']|lower}}"
              entered_zones: "{{trigger.payload_json['after']['entered_zones']}}"
              current_zones: "{{trigger.payload_json['after']['current_zones']}}"
              offset_zones: "{{entered_zones|list|join(', ')}} => {{current_zones|list|join(', ')}}"
              start_time: "{{trigger.payload_json['after']['start_time']|timestamp_custom('%Y-%m-%d %H:%M:%S', default='00:00:00')}}"
              end_time: "{{trigger.payload_json['after']['end_time']|timestamp_custom('%H:%M:%S', default='00:00:00')}}"
              msg_tag: "mot-cam-{{video_id}}"
              in_text_message: !input in_text_message
              mes_caption: "üì∏{{in_text_message}}"
              url_thumb: "{{frigate_api}}/{{video_id}}/{{in_type_photo}}.jpg"

          - if:
              - not:
                  - and:
                      - "{{not in_object_event|length or in_object_event|select('in', label)|list|length > 0}}"
                      - "{{not in_zones|length or in_zones|select('in', entered_zones)|list|length > 0}}"
            then:
              # - service: notify.{{event_notify}}
              #   data:
              #     message: "*–ü–†–û–ü–£–©–ï–ù–ù–û!!!*{{'\n'}}{{mes_caption}}"
              - stop: –û–±—ä–µ–∫—Ç –∏–ª–∏ –∑–æ–Ω–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç

          - parallel:
              - service: notify.{{event_notify}}
                data:
                  message: "{{mes_caption}}"
                  data:
                    photo:
                    - url: "{{url_thumb}}"
                      caption: "{{mes_caption[:1024]}}"
                    inline_keyboard: >-
                        ‚ùå:/frigate_{{camera}} {{video_id}} delete, üì≤:/frigate_{{camera}} {{video_id}} live
                    message_tag: "{{msg_tag}}"
              - if: []
                then:
                  - wait_for_trigger:
                      - platform: event
                        event_type: telegram_sent
                        event_data:
                          message_tag: "{{msg_tag}}"
                    timeout: "00:00:30"
                  - if:
                      - condition: template
                        value_template: "{{not wait.trigger}}"
                    then:
                      - stop: –Ω–µ–±—ã–ª–æ —Å–æ–±—ã—Ç–∏—è telegram_sent –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                  - variables:
                      message_id: "{{wait.trigger.event.data.message_id}}"
                      chat_id: "{{wait.trigger.event.data.chat_id }}"
                  - repeat:
                      until:
                        - condition: template
                          value_template: "{{wait.trigger.payload_json['type'] == 'end'}}"
                      sequence:
                        - wait_for_trigger:
                            - platform: mqtt
                              topic: frigate/events
                              payload: "{{video_id}}"
                              value_template: "{{value_json['after']['id']}}"
                          timeout: "00:45:00"
                        - if:
                            - condition: template
                              value_template: "{{not wait.trigger}}"
                          then:
                            - service: telegram_bot.edit_caption
                              data:
                                message_id: "{{message_id}}"
                                chat_id: "{{chat_id}}"
                                caption: "{{mes_caption}}"
                                inline_keyboard:
                                  - "‚ùå–°–æ–±—ã—Ç–∏–µ –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ:/frigate_{{camera}} {{video_id}} delete"
                            - stop: –∏—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –¥–ª—è —Å–æ–±—ã—Ç–∏—è
                        - condition: template
                          value_template: "{{wait.trigger.payload_json['type'] == 'end'}}"
                        - variables:
                            end_time: "{{wait.trigger.payload_json['after']['end_time']|timestamp_custom('%H:%M:%S', default='00:00:00')}}"
                            entered_zones: "{{trigger.payload_json['after']['entered_zones']}}"
                            current_zones: "{{wait.trigger.payload_json['after']['current_zones']}}"
                            offset_zones: "{{entered_zones|list|join(', ')}} => {{current_zones|list|join(', ')}}"
                            in_text_message: !input in_text_message
                            mes_caption: "üì∏{{in_text_message}}"
                        - service: telegram_bot.edit_caption
                          data:
                            message_id: "{{message_id}}"
                            chat_id: "{{chat_id}}"
                            caption: "{{mes_caption[:1024]}}"
                            inline_keyboard: >-
                              üì≤:/frigate_{{camera}} {{video_id}} live, ‚ùå:/frigate_{{camera}} {{video_id}} delete, üìº:/frigate_{{camera}} {{video_id}} clip
              - choose:
                  - conditions: []
                    sequence: !input in_action


      - alias: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ –¢–ì"
        conditions:
          - condition: trigger
            id: telegram-command
        sequence:
          - variables:
              video_id: "{{trigger.event.data.args[0]}}"
              command_tg: "{{trigger.event.data.args[1]}}"
              camera: "{{trigger.event.data.command.split('_')[1]}}"
              chat_id: "{{trigger.event.data.chat_id}}"
              user_id: "{{trigger.event.data.user_id}}"
              message_id: "{{trigger.event.data.message.message_id}}"
              button_id: "{{trigger.event.data.id}}"
              button_id_pic: "{{((command_tg == 'thumb')|iif(button_id, False))}}"
              mes_caption: "{{trigger.event.data.message.caption}}"
          - service: logbook.log
            data:
                name: "{{this.attributes.friendly_name}}"
                message: "–°–æ–±—ã—Ç–∏–µ {{command_tg}} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{user_id}} {{trigger.event.data.from_first|default('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}} {{video_id}} {{mes_caption}}."
                entity_id: "{{this.entity_id}}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{command_tg=='delete'}}"
                sequence:
                  - service: rest_command.delete_event_frigate
                    data:
                      event_id: "{{video_id}}"
                  - service: telegram_bot.delete_message
                    continue_on_error: true
                    data:
                      message_id: "{{message_id}}"
                      chat_id: "{{chat_id}}"
                  - service: telegram_bot.answer_callback_query
                    continue_on_error: true
                    data:
                      show_alert: false
                      message: –£–¥–∞–ª–µ–Ω–æ {{mes_caption}}
                      callback_query_id: "{{button_id}}"

              - conditions:
                  - condition: template
                    value_template: "{{command_tg=='live'}}"
                sequence:
                  - service: "notify.{{notify_mobile}}"
                    data:
                      message: clear_notification
                      data:
                        tag: camera-strim
                  - service: "notify.{{notify_mobile}}"
                    data:
                      message: –°—Ç—Ä–∏–º {{camera}}
                      data:
                        entity_id: camera.{{camera}}
                        tag: camera-strim
                  - service: telegram_bot.answer_callback_query
                    data:
                      show_alert: false
                      message: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å—Ç—Ä–∏–º
                      callback_query_id: "{{button_id}}"

              - conditions:
                  - condition: template
                    value_template: "{{command_tg=='reload'}}"
                sequence:
                  - service: telegram_bot.edit_replymarkup
                    data:
                      message_id: "{{message_id}}"
                      chat_id: "{{chat_id}}"
                      inline_keyboard: >-
                        üì≤:/frigate_{{camera}} {{video_id}} live, ‚ùå:/frigate_{{camera}} {{video_id}} delete, üìº:/frigate_{{camera}} {{video_id}} clip

              - conditions:
                  - condition: template
                    value_template: "{{command_tg=='clip'}}"
                sequence:
                  - service: telegram_bot.edit_replymarkup
                    data:
                      message_id: "{{message_id}}"
                      chat_id: "{{chat_id}}"
                      inline_keyboard: >-
                        ‚è≥–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ‚è≥:/frigate_{{camera}} {{video_id}} reload
                  - service: python_script.exec
                    data:
                      cache: true
                      new_file: "{{frigate_api}}/{{video_id}}/clip.mp4"
                      message_id: "{{message_id}}"
                      new_message: "{{mes_caption.replace('üì∏','üé•')}}"
                      chat_id: "{{chat_id}}"
                      button_id: "{{button_id}}"
                      keyboard: >-
                          üîÑ:/frigate_{{camera}} {{video_id}} clip, üîö:/frigate_{{camera}} {{video_id}} thumb
                      file: /config/python_scripts/edit_media_telegram.py
                  - wait_for_trigger:
                      - platform: event
                        event_type: telegram_callback
                        event_data:
                          data: "/frigate_{{camera}} {{video_id}} thumb"
                    timeout: !input in_time_wait
                  - variables:
                      button_id: |-
                        {%-if not wait.trigger-%}
                          False
                        {%-else-%}
                          {{-wait.trigger.event.data.id-}}
                        {%-endif-%}
                  - service: python_script.exec
                    data:
                      cache: true
                      new_file: "{{frigate_api}}/{{video_id}}/{{in_type_photo}}.jpg"
                      message_id: "{{message_id}}"
                      new_message: "{{mes_caption.replace('üé•','üì∏')}}"
                      chat_id: "{{chat_id}}"
                      button_id: "{{button_id}}"
                      keyboard: >-
                        üì≤:/frigate_{{camera}} {{video_id}} live, ‚ùå:/frigate_{{camera}} {{video_id}} delete, üìº:/frigate_{{camera}} {{video_id}} clip
                      file: /config/python_scripts/edit_media_telegram.py

            default:
              - delay:
                  hours: 0
                  minutes: 0
                  seconds: 3
                  milliseconds: 0
              - service: telegram_bot.answer_callback_query
                data:
                  show_alert: true
                  message: ü§î–ï—Å–ª–∏ —É–≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ –∫–∞–∂–µ—Ç—Å—è —á—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –û–±–Ω–æ–≤–∏—Ç–µ üîÑ —Å–æ–æ–±—â–µ–Ω–∏–µ.
                  callback_query_id: "{{button_id}}"
