blueprint:
  name: ðŸ“¢Ð“Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚ÑŒ Ð¸ Ð¿Ð°ÑƒÐ·Ð° Ð¯ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¸ ÐºÐ¾Ð³Ð´Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¸ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ ÐÐ»Ð¸ÑÐ°
  domain: automation
  description: |
    Ð—Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð° ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¸ alice_state Ð½Ð° LISTENING Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¸ Ð½Ð¸Ð¶Ðµ Ð½Ð° SPEAKING.
  input:
    in_station:
      name: ÐšÐ¾Ð»Ð¾Ð½ÐºÐ°
      description: ÐšÐ¾Ð»Ð¾Ð½ÐºÐ°
      selector:
        entity:
          domain: media_player
          integration: yandex_station
    in_level_voice_entity:
      name: Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð³Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚Ð¸
      description: Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð³Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚Ð¸ ÐºÐ¾Ð³Ð´Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¸Ð»Ð¸ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚
      default: 0.5
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
    in_speaking_condition:
      name: Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸ SPEAKING
      description: Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸ SPEAKING.
      default: false
      selector:
        boolean:
    in_pause_play:
      name: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ
      description: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ
      default: false
      selector:
        boolean:
    in_condition:
      name: (Ð”Ð¾Ð¿) Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
      description: Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°.
      default: []
      selector:
        action:

trace:
  stored_traces: 100

mode: parallel

max: 100

variables:
  in_station: !input in_station
  in_level_voice_entity: !input in_level_voice_entity
  in_pause_play: !input in_pause_play
  in_speaking_condition: !input in_speaking_condition
  level_voice: "{{in_level_voice_entity|float(0.5)}}"
  old_level_voice: "{{state_attr(in_station, 'volume_level')|float(0.2)}}"
  states_station: "{{states(in_station)}}"

trigger_variables:
  in_station: !input in_station

trigger:
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: LISTENING
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: SPEAKING
    id: SPEAKING

condition: 
  - condition: or
    conditions:
      - condition: not
        conditions:
          - condition: trigger
            id: SPEAKING
      - condition: and
        conditions:
          - condition: trigger
            id: SPEAKING
          - condition: template
            value_template: "{{in_speaking_condition}}"

action:
  - condition: !input in_condition
  - condition: template
    value_template: "{{old_level_voice != level_voice}}"
  - condition: template
    value_template: "{{state_attr(in_station, 'is_volume_muted') == false}}"
  - if:
      - condition: template
        value_template: "{{in_pause_play and states_station == 'playing'}}"
    then:
      - service: media_player.media_pause
        data: {}
        target:
          entity_id: !input in_station
  - service: media_player.volume_set
    target:
      entity_id: "{{in_station}}"
    data:
      volume_level: "{{level_voice}}"
  - wait_for_trigger:
      - platform: state
        entity_id: !input in_station
        attribute: alice_state
        to: IDLE
        for:
          hours: 0
          minutes: 0
          seconds: 1
    timeout: '00:10:00'
  - variables:
      volume_level: >-
        {%- if state_attr(in_station, 'volume_level')|float(0.0) !=
        level_voice -%}
          {{- (old_level_voice + state_attr(in_station, 'volume_level')|float(0.0) - level_voice)|round(1,default=20) -}}
        {%- else -%}
          {{- old_level_voice -}}
        {%- endif -%}  
  - service: media_player.volume_set
    target:
      entity_id: "{{in_station}}"
    data:
      volume_level: "{{volume_level}}"
  - if:
      - condition: template
        value_template: "{{in_pause_play and states_station == 'playing'}}"
    then:
      - service: media_player.media_play
        target:
              entity_id: !input in_station
        data: {}