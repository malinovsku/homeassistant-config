blueprint:
  name: üì¢–ì—Ä–æ–º–∫–æ—Å—Ç—å –∏ –ø–∞—É–∑–∞ –Ø—Å—Ç–∞–Ω—Ü–∏–∏ –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—Ç –∏ —Å–ª—É—à–∞–µ—Ç –ê–ª–∏—Å–∞
  domain: automation
  description: |
    –ó–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∞—Ç—Ä–∏–±—É—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–∏ alice_state –Ω–∞ LISTENING –∏–ª–∏ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ –Ω–∏–∂–µ –Ω–∞ SPEAKING.
  input:
    in_station:
      name: –ö–æ–ª–æ–Ω–∫–∞
      description: –ö–æ–ª–æ–Ω–∫–∞
      selector:
        entity:
          domain: media_player
          integration: yandex_station
    in_all_station:
      name: –ì—Ä—É–ø–ø–∞ —Å—Ç–∞–Ω—Ü–∏–π
      description: –ì—Ä—É–ø–ø–∞ —Å—Ç–∞–Ω—Ü–∏–π –¥–ª—è —Å–æ–±—ã—Ç–∏—è station_volume, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ SPEAKING.
      default: media_player.yandex_station_vse
      selector:
        entity:
          domain: media_player
    in_level_voice_entity:
      name: –û–±—ä–µ–∫—Ç –¥–ª—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      description: –û–±—ä–µ–∫—Ç –¥–ª—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      selector:
        entity:
          domain: input_number
    in_speaking_condition:
      name: –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ SPEAKING
      description: –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ SPEAKING.
      default: false
      selector:
        boolean:
    in_pause_play:
      name: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∞—É–∑—É
      description: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∞—É–∑—É
      default: false
      selector:
        boolean:
    in_condition:
      name: (–î–æ–ø) –£—Å–ª–æ–≤–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞
      description: –£—Å–ª–æ–≤–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞.
      default: []
      selector:
        action:

trace:
  stored_traces: 100

mode: parallel

max: 100

variables:
  in_station: !input in_station
  in_level_voice_entity: !input in_level_voice_entity
  in_pause_play: !input in_pause_play
  in_speaking_condition: !input in_speaking_condition
  level_voice: "{{states(in_level_voice_entity)|float(0.0)}}"
  old_level_voice: "{{state_attr(in_station, 'volume_level')}}"
  state_station: "{{states(in_station)}}"

trigger_variables:
  in_station: !input in_station

trigger:
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: LISTENING
    variables:
      gromkost: max
  - platform: event
    event_type: station_volume
    event_data:
      station: "{{in_station}}"
    variables:
      gromkost: "{{trigger.event.data.gromkost}}"
  - platform: event
    event_type: station_volume
    event_data:
      station: !input in_all_station
    variables:
      gromkost: "{{trigger.event.data.gromkost}}"
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: SPEAKING
    variables:
      gromkost: max
    id: SPEAKING

condition: 
  - condition: or
    conditions:
      - condition: not
        conditions:
          - condition: trigger
            id: SPEAKING
      - condition: and
        conditions:
          - condition: trigger
            id: SPEAKING
          - condition: template
            value_template: "{{in_speaking_condition}}"

action:
  - condition: !input in_condition
  - variables:
      new_volume_level: "{{(gromkost == 'max') | iif(level_voice, 0.0)}}"
  # - condition: template
  #   value_template: "{{old_level_voice != level_voice}}"
  - condition: template
    value_template: "{{old_level_voice < level_voice}}"
  - condition: template
    value_template: "{{state_attr(in_station, 'is_volume_muted') == false}}"
  - if:
      - condition: template
        value_template: "{{in_pause_play and states_station == 'playing'}}"
    then:
      - service: media_player.media_pause
        data: {}
        target:
          entity_id: !input in_station
  - service: media_player.volume_set
    target:
      entity_id: "{{in_station}}"
    data:
      volume_level: "{{new_volume_level}}"
  - wait_for_trigger:
      - platform: state
        entity_id: !input in_station
        attribute: alice_state
        to: IDLE
        for:
          hours: 0
          minutes: 0
          seconds: 3
    timeout: '00:10:00'
  - if:
      - condition: template
        value_template: "{{state_attr(in_station, 'volume_level')|float(0.0) == level_voice or state_attr(in_station, 'is_volume_muted') == true}}"
    then:
      - service: media_player.volume_set
        target:
          entity_id: "{{in_station}}"
        data:
          volume_level: "{{old_level_voice}}"
  - if:
      - condition: template
        value_template: "{{in_pause_play and states_station == 'playing'}}"
    then:
      - service: media_player.media_play
        target:
              entity_id: !input in_station
        data: {}
