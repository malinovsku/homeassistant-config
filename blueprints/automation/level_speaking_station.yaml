blueprint:
  name: ðŸ”®ÐŸÐ¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° ÐºÐ¾Ð³Ð´Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¸ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ ÐÐ»Ð¸ÑÐ°
  domain: automation
  description: ÐŸÐ¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° ÐºÐ¾Ð³Ð´Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¸ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ ÐÐ»Ð¸ÑÐ°
  input:
    in_station:
      name: ÐšÐ¾Ð»Ð¾Ð½ÐºÐ°
      selector:
        entity:
          domain: media_player
          integration: yandex_station
    in_light:
      name: Ð›Ð°Ð¼Ð¿Ð° Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÐ²ÐµÑ‚ÐºÐ¸
      selector:
        entity:
            domain: light
    in_light_night:
      name: ÐžÐ±ÑŠÐµÐºÑ‚ ON\OFF Ð´Ð»Ñ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÑ€ÐºÐ¾ÑÑ‚Ð¸
      description: |
        **ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ sun.sun ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð°.**
        ÐŸÑ€Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ ON ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ñ 255\10, Ð¿Ñ€Ð¸ OFF ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ 30\3. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð´Ð»Ñ Ð´ÐµÐ½ÑŒ\Ð½Ð¾Ñ‡ÑŒ.
      default: sun.sun
      selector:
        entity:
    in_condition_activ_scene:
      name: (Ð”Ð¾Ð¿) ÐžÐ±ÑŠÐµÐºÑ‚ ON\OFF Ð´Ð»Ñ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð»Ð°Ð¼Ð¿Ñ‹ Ð² ÐºÐ¾Ð½Ñ†Ðµ
      description: |
        **ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ sun.sun ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð°.**
        (Ð”Ð¾Ð¿) ÐŸÑ€Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ ON Ð»Ð°Ð¼Ð¿Ð° Ð² ÐºÐ¾Ð½Ñ†Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°, Ð¿Ñ€Ð¸ OFF Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð° ÑÑ†ÐµÐ½Ð° Ð»Ð°Ð¼Ð¿Ñ‹ ÐºÐ°Ðº Ð´Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°. 
      default: sun.sun
      selector:
        entity:
    in_condition:
      name: (Ð”Ð¾Ð¿) Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
      description: (Ð”Ð¾Ð¿) Ð¢Ð¸Ð¿ Ð´ÐµÐ¹Ñ‚ÑÐ²Ð¸Ñ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ. Ð”Ð»Ñ Ð¾Ð³Ñ€Ð°Ð½Ñ‡ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸.
      default: []
      selector:
        # action:
        condition:
    in_color_speaking:
      name: (Ð”Ð¾Ð¿) Ð¦Ð²ÐµÑ‚ ÐºÐ¾Ð³Ð´Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚
      default: [190, 0 , 255]
      selector:
        color_rgb:
    in_color_listening:
      name: (Ð”Ð¾Ð¿) Ð¦Ð²ÐµÑ‚ ÐºÐ¾Ð³Ð´Ð° ÑÐ»ÑƒÑˆÐ°ÐµÑ‚
      default: [0, 255, 191]
      selector:
        color_rgb:

max_exceeded: silent

mode: single

variables:
  in_light: !input in_light
  in_light_night: !input in_light_night
  in_color_speaking: !input in_color_speaking
  in_color_listening: !input in_color_listening
  in_condition_activ_scene: !input in_condition_activ_scene
  scene_name: "{{'kolonka_voice_old_state_' + in_light.split('.')[1]}}"
  br_light_min: "{{(states(in_light_night) != 'on')|iif(10, 3)}}"
  br_light_max: "{{(states(in_light_night) != 'on')|iif(255, 30)}}"


trigger:
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: SPEAKING
  - platform: state
    entity_id: !input in_station
    attribute: alice_state
    to: LISTENING

condition: !input in_condition

action:
  - service: scene.create
    data:
      scene_id: >-
        {{scene_name}}
      snapshot_entities: !input in_light
  - repeat:
      until:
        - condition: or
          conditions: 
            - condition: state
              entity_id: !input in_station
              attribute: alice_state
              state: IDLE
              for:
                hours: 0
                minutes: 0
                seconds: 1
                milliseconds: 0
            - condition: state
              entity_id: !input in_station
              attribute: alice_state
              state: IDLE
              for:
                hours: 0
                minutes: 0
                seconds: 2
                milliseconds: 0
      sequence:
        - if:
            - condition: state
              entity_id: !input in_station
              attribute: alice_state
              state: LISTENING
          then:
                - repeat:
                    while:
                      - condition: state
                        entity_id: !input in_station
                        attribute: alice_state
                        state: LISTENING
                    sequence:

                      - variables:
                          in_color_listening: "{{in_color_listening}}"
                          brightness: "{{(states(in_light_night) != 'on')|iif(255, 30)}}"

                      - service: light.turn_on
                        data:
                          rgb_color: "{{in_color_listening}}"
                          transition: 1
                          effect: Solid
                          brightness: "{{(states(in_light_night) != 'on')|iif(255, 30)}}"
                        target:
                          entity_id: !input in_light

                      - condition: state
                        entity_id: !input in_station
                        attribute: alice_state
                        state: LISTENING

                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            # from: SPEAKING
                        timeout: '00:00:01'

                      - condition: state
                        entity_id: !input in_station
                        attribute: alice_state
                        state: LISTENING

                      - service: light.turn_on
                        data:
                          rgb_color: "{{in_color_listening}}"
                          transition: 1
                          effect: Solid
                          brightness: "{{(states(in_light_night) != 'on')|iif(10, 3)}}"
                        target:
                          entity_id: !input in_light

                      - condition: state
                        entity_id: !input in_station
                        attribute: alice_state
                        state: LISTENING

                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            # from: SPEAKING
                        timeout: '00:00:01'
          else:
                - repeat:
                    until:
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: !input in_station
                            attribute: alice_state
                            state: LISTENING
                          - condition: state
                            entity_id: !input in_station
                            attribute: alice_state
                            state: IDLE
                    sequence:

                      - variables:
                          in_color_listening: "{{in_color_listening}}"
                          brightness: "{{(states(in_light_night) != 'on')|iif(255, 30)}}"

                      - service: light.turn_on
                        data:
                          transition: 1
                          brightness: "{{(states(in_light_night) != 'on')|iif(255, 30)}}"
                          effect: Solid
                          rgb_color: "{{in_color_speaking}}"
                        target: 
                          entity_id: !input in_light

                      - condition: not
                        conditions:
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: LISTENING
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: IDLE

                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            from: LISTENING
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            from: IDLE
                        timeout: '00:00:01'

                      - condition: not
                        conditions:
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: LISTENING
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: IDLE

                      - service: light.turn_on
                        data:
                          brightness: "{{(states(in_light_night) != 'on')|iif(10, 3)}}"
                          transition: 1
                          effect: Solid
                          rgb_color: "{{in_color_speaking}}"
                        target: 
                          entity_id: !input in_light

                      - condition: not
                        conditions:
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: LISTENING
                              - condition: state
                                entity_id: !input in_station
                                attribute: alice_state
                                state: IDLE

                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            from: LISTENING
                          - platform: state
                            entity_id: !input in_station
                            attribute: alice_state
                            from: IDLE
                        timeout: '00:00:01'
  - if:
      - condition: template
        value_template: "{{in_condition_activ_scene != 'sun.sun'}}"
      - condition: state
        entity_id: !input in_condition_activ_scene
        state: 'on'
    then:
      - service: light.turn_off
        data: {}
        target:
          entity_id: !input in_light
    else:
      - service: scene.turn_on
        target:
          entity_id: 'scene.{{scene_name}}'
